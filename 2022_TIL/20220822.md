## 감사일기
- 나: 정상적으로 출근한 나에게 감사한다
- 타인: 어제 열두시에 모인 도른자들 넘나 재밌고 기대된다
- 물질: 아침에 커피 한잔...크..
- 경험: 오늘 아침에 머리를 감고 와서 다행이다 

## TIL 

## 2장 쿼리 필수 요소 
- 구글 빅쿼리 완벽 가이드를 참고하여 작성하였습니다.
- p.68~ 배열과 구조체 기초 

### EXCEPT, REPLACE 
```sql
SELECT * EXCEPT(name,gender)
FROM people

SELECT * REPLACE (name -2 AS name)
FROM people
```
### UNNEST / ARRAY란?
```SELECT * FROM UNNEST(['Seattle WA', 'New York', 'Singapore']) AS city```
- NEST: 둥지, NESTED SQL 중첩된 쿼리
- UNNEST: 평면화 시키는 것 , 둥지 해체!

이런 상황에 배열을 평면화(Flatten)해서 배열에 있는 값을 펴줘야 함
배열을 펴줄 때 사용하는 것은 UNNEST로, Nest한 데이터를 UNNEST하게 만드는 것
UNNEST 연산자는 ARRAY를 입력으로 받고 ARRAY의 각 요소에 대한 행이 한 개씩 포함된 테이블을 return함
[출처](https://zzsza.github.io/gcp/2020/04/12/bigquery-unnest-array-struct/) 

```sql
SELECT
      city,SPLIT(city,' ')AS parts
      FROM (
         SELECT * FROM UNNEST([
           'Seattle WA', 'New York', 'Singapore']) AS city
      )
```
- ARRAY로 만들고 [] - 대괄호 , UNNEST로 평면화 해준 다음에 SPLIT으로 쪼개기 

### ARRAY_AGG
### STRUCT (구조체)
```sql
SELECT
 [
   STRUCT('male' AS gender , [11111,22222] AS numtrips)
   ,STRUCT('female' AS gender,[3333,4444] AS numtrips)
 ] AS bike
```
- 컬럼 이름과 struct를 지정해주지 않으면 익명 컬럼 처리됨으로 유지보수, 재활용을 위해 꼭 이름을 지정하도록 하자. 
- UNNEST: 배열의 요소를 행으로 반환하는 함수로, 결과 배열을 풀면 (UNNEST하면) 각 배열의 각 항목에 해당하는 행을 가져올 수 있다. 
- 배열의 일부만 풀 수도 있다.
```sql
SELECT numtrips FROM UNNEST(
 [
   STRUCT('male' AS gender , [11111,22222] AS numtrips)
   ,STRUCT('female' AS gender,[3333,4444] AS numtrips)
 ] )AS bike
```
- 다음 쿼리는 numtrips 컬럼의 값만 얻는다 
### JOIN 
- CROSS JOIN (상호 조인) 한 쪽 테이블의 모든 행들과 다른 테이블의 모든 행을 조인시키는 기능을 한다.
- SQL 그렇게 많이 했는데 왜 CROSS JOIN 모르지..? 했는데 
```sql
SELECT *
FROM A,B 
```
- 쉼표로 테이블 합치는 것과 같은 역할을 하고 이게 더 쉬워서 쉼표 크로스 조인이라고도 한대. 난 이렇게 썼으니....
## 3장 데이터 타입, 함수, 연산자 
### SAFE 접두사 
```sql
SELECT SAFE.LOG(10,-3), LOG(10,3)
```
- 음수일 때 등 오류를 발생시키지 않고 NULL을 반환한다.
- ROUND, SUBSTR등 스칼라 함수에만 사용할 수 있다.

### COALESCE, IFNULL
- COALESCE : null이 아닌 첫 번째 표현식의 값을 반환합니다. (COALESCE 뜻: 합체하다)
```sql
COALESCE (a,b) = IFNULL(a,b)
```
- a가 NULL이면 b를 반환

### CAST, SAFE_CAST (타입 변환, 타입 강제)
```sql
SELECT SAFE_CAST(hours_worked AS INT64) : 에러 안나오고 Null 값이 나오게 할 수 있음 

SELECT CAST(hours_worked AS INT64) 
```
- 명시적 타입 변환 
- 암시적 타입 변환 : 빅쿼리는 INT64 -> FLOAT64,NUMERIC OR NUMERIC-> FLOAT64 로만 지원  
